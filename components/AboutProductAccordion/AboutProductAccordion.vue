<template>
  <Accordion :multiple="true" :activeIndex="[0]" :pt="{
    root: { class: 'border-none bg-transparent' },
    header: { class: 'border-none bg-transparent text-[18px] text-[var(--color-primary-dark)] fw-600' },
    content: { class: 'pt-2' }
  }">
    <AccordionPanel class="accordion-item" value="0">
      <AccordionHeader :pt="{
        root: {
          class: 'accordion-header',
          style: 'background-color: var(--color-gray-lavender); border: none;'
        }
      }">{{ tabs.description.header }}
      </AccordionHeader>
      <AccordionContent :pt="{
        content : {
          style : 'background-color: var(--color-gray-lavender);'
        }
      }">
        <ClientOnly>
          <div v-if="product.description">
            <p
                class="fw-500 text-[18px] leading-[34px] text-[var(--color-primary-dark)]"
                v-html="product.description"
            />
          </div>
          <p  v-else class="no-data-text">
            {{ t('description_no_data') }}
          </p>
        </ClientOnly>
      </AccordionContent>
    </AccordionPanel>

    <AccordionPanel class="accordion-item" value="1">
      <AccordionHeader :pt="{
        root: {
          class: 'accordion-header',
          style: 'background-color: var(--color-gray-lavender);'
        }
      }">{{ tabs.characteristics.header }}
      </AccordionHeader>
      <AccordionContent :pt="{
        content : {
          style : 'background-color: var(--color-gray-lavender);'
        }
      }">
        <div v-if="product?.attributes.length" class="characteristics-list w-full">
          <div
              v-for="characteristic in product?.attributes"
              :key="characteristic.key"
              class="flex items-start gap-4 py-2"
          >
            <p class="characteristics-list__title whitespace-nowrap">
              {{ characteristic.key }}
            </p>
            <div class="characteristics-separator flex-grow h-px bg-[#5856D6] mt-[1.3em]"></div>
            <p class="characteristics-list__value text-right">
              {{ characteristic.value ? characteristic.value : t('characteristics_no_data') }}
            </p>
          </div>
        </div>
        <p  v-else class="no-data-text">
          {{ t('characteristics_no_data') }}
        </p>
      </AccordionContent>
    </AccordionPanel>

    <AccordionPanel class="accordion-item" value="2">
      <AccordionHeader :pt="{
        root: {
          class: 'accordion-header',
          style: 'background-color: var(--color-gray-lavender);'
        }
      }">{{ tabs.delivery.header }}
      </AccordionHeader>
      <AccordionContent :pt="{
        content : {
          style : 'background-color: var(--color-gray-lavender);'
        }
      }">
        <div v-if="true" class="delivery-and-payment">
          <div class="mb-4">
            <strong class="fw-600 leading-[33px]">–û–ø–ª–∞—Ç–∞</strong>
          </div>
          <p class="mb-4">
            –û–ø–ª–∞—Ç–∞ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <strong>Telegram</strong>. –ü—ñ—Å–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—à
            –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤‚Äô—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É Telegram –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –Ω–∞–¥–∞—Å—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏.
          </p>

          <div class="mb-4">
            <strong>–î–æ—Å—Ç—É–ø–Ω—ñ –º–µ—Ç–æ–¥–∏ –æ–ø–ª–∞—Ç–∏:</strong>
            <ul class="list-disc pl-6">
              <li>–ë–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π –ø–µ—Ä–µ–∫–∞–∑ (Monobank, –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫ —Ç–∞ —ñ–Ω—à—ñ)</li>
              <li>–ü–µ—Ä–µ–∫–∞–∑ –Ω–∞ –∫–∞—Ä—Ç–∫—É</li>
              <li>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (–∑–∞ –∑–∞–ø–∏—Ç–æ–º)</li>
            </ul>
          </div>

          <div class="mb-4">
            <strong>–î–æ—Å—Ç–∞–≤–∫–∞</strong>
            <div>
              <p>–ü–æ –£–∫—Ä–∞—ó–Ω—ñ:</p>
              <ul class="list-disc pl-6">
                <li>–ù–æ–≤–∞ –ü–æ—à—Ç–∞ ‚Äì 1-3 –¥–Ω—ñ, –∑–≥—ñ–¥–Ω–æ –∑ —Ç–∞—Ä–∏—Ñ–∞–º–∏ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</li>
                <li>–£–∫—Ä–ø–æ—à—Ç–∞ ‚Äì 3-7 –¥–Ω—ñ–≤</li>
              </ul>
            </div>
            <div>
              <p>–ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞:</p>
              <ul class="list-disc pl-6">
                <li>–î–æ—Å—Ç–∞–≤–∫–∞ –≤ —ñ–Ω—à—ñ –∫—Ä–∞—ó–Ω–∏ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ –ø–æ—à—Ç–æ–≤—ñ —Å–µ—Ä–≤—ñ—Å–∏</li>
                <li>–¢–µ—Ä–º—ñ–Ω–∏ —Ç–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∫—Ä–∞—ó–Ω–∏ –æ–¥–µ—Ä–∂—É–≤–∞—á–∞ —Ç–∞ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</li>
                <li>–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∫–∏</li>
              </ul>
            </div>
          </div>

          <div>
            <p>üìå –í–∞–∂–ª–∏–≤–æ!</p>
            <ul class="list-disc pl-6">
              <li>–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ—ó –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∏</li>
              <li>–¢–æ—á–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–æ—ó –¥–æ—Å—Ç–∞–≤–∫–∏ —É—Ç–æ—á–Ω—é–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ Telegram</li>
            </ul>
          </div>
        </div>
        <p  v-else class="no-data-text no-data-reviews">
          {{ t('delivery_no_data') }}
        </p>
      </AccordionContent>
    </AccordionPanel>

    <AccordionPanel class="accordion-item" value="3">
      <AccordionHeader :pt="{
        root: {
          class: 'accordion-header',
          style: 'background-color: var(--color-gray-lavender);'
        }
      }">{{ tabs.reviews.header }}
      </AccordionHeader>
      <AccordionContent :pt="{
        content : {
          style : 'background-color: var(--color-gray-lavender);'
        }
      }">
        <section class="reviews-content murecho-font flex flex-col">
          <section v-if="paginatedReviews.length" class="review-list max-w-[650px] w-full pt-[26px] justify-self-start">
            <div class="reviews min-h-[270px] flex flex-col justify-between">
              <article
                  class="review-card mb-[23px] last:mb-0 max-w-[618px]"
                  v-for="review in paginatedReviews"
                  :key="review.id"
              >
                <div class="review-header flex flex-col mb-2 items-start">
                  <div class="max-w-[306px] w-full justify-between flex items-center">
                    <strong class="mr-4">
                      <p class="review-card__name fw-600">{{ fullReviewerName(review.user) }}</p>
                    </strong>
                    <time class="review-card__date mr-2 text-[14px]" :datetime="review.createdAt">
                      {{ formatDateToDMY(review.createdAt) }}
                    </time>
                  </div>
                  <div class="flex items-center">
                    <div class="review-card__stars mr-3">
                      <Rating v-model="review.rating" readonly>
                        <template #onicon>
                          <img src="../../assets/icons/star-filled.svg" class="mr-1" />
                        </template>
                        <template #officon>
                          <img src="../../assets/icons/star-empty.svg" class="mr-1" />
                        </template>
                      </Rating>
                    </div>
                    <div class="review-card__confirmed text-[#ADADAD] fw-400">
                      <p v-if="true">{{ t('purchase_confirmed') }}</p>
                      <p v-else>{{ t('purchase_not_confirmed') }}</p>
                    </div>
                  </div>
                </div>

                <div class="review-body">
                  <p class="review-card__comment">{{ getSlicedReview(review) }}</p>
                  <p
                      v-if="isShowMoreButton(review.comment)"
                      class="flex cursor-pointer justify-end text-[12px] text-[var(--color-muted-light-gray)] fw-500"
                      @click="toggleComment(review._id)"
                  >
                    {{ expandedComments.has(review._id) ? 'Hide' : 'Read more' }}
                  </p>
                </div>
              </article>

              <nav class="pagination-wrapper flex justify-end" aria-label="Review pagination">
                <div class="pagination flex justify-between items-center max-w-[80px] w-full">
                  <button
                      @click="changePage(currentPage - 1)"
                      :disabled="currentPage === 1"
                      :class="{ 'is-disabled': currentPage === 1 }"
                      aria-label="Previous page"
                  >
                  </button>
                  <span>{{ currentPage }}</span>
                  <button
                      @click="changePage(currentPage + 1)"
                      :disabled="currentPage * itemsPerPage >= reviews.length"
                      :class="{ 'is-disabled': currentPage * itemsPerPage >= reviews.length }"
                      aria-label="Next page"
                  >
                  </button>
                </div>
              </nav>
            </div>
          </section>

          <section v-else class="no-data-text no-data-reviews">
            <p class="no-data-text text-center mb-6">
              {{ t('no_reviews_yet') }}
            </p>
          </section>

          <section class="review-form max-w-[642px] w-full" aria-label="Review submission form">
            <div class="mb-4">
              <h2 class="form-title fw-500">{{ t('new_review') }}</h2>
            </div>

            <form @submit.prevent="leaveProductReview">
              <div class="mb-4 rounded-[8px] max-w-[354px]">
                <InputText
                    :disabled="!token"
                    v-model="reviewerInputValue"
                    class="w-full h-[42px] py-[10px] rounded-[8px]"
                    :placeholder="t('your_name')"
                />
              </div>

              <div class="rounded-[8px]">
        <Textarea
            :disabled="!token"
            :maxlength="MAX_REVIEW_LENGTH"
            v-model="textareaValue"
            style="resize: none"
            class="w-full rounded-[8px]"
            :placeholder="t('share_your_impressions')"
            rows="5"
            cols="30"
        />
              </div>

              <div class="mb-[10px] text-[var(--color-muted-light-gray)] flex justify-end">
                {{ getReviewLength }} / {{ MAX_REVIEW_LENGTH }}
              </div>

              <div class="rate-product mb-[27px] flex flex-col">
                <div class="flex items-center">
                  <p class="mr-[10px] text-[14px]">{{ t('rate_product') }}</p>
                  <Rating :disabled="!token" v-model="rating">
                    <template #onicon>
                      <img src="../../assets/icons/star-filled.svg" class="mr-1" />
                    </template>
                    <template #officon>
                      <img src="../../assets/icons/star-empty.svg" class="mr-1" />
                    </template>
                  </Rating>
                </div>
                <p v-if="isEmptyRating" class="empty-rating-text text-[12px] text-[var(--color-primary-pink)]">
                  {{ t('empty_rating') }}
                </p>
              </div>

              <div class="rounded-[8px] review-button__wrapper max-w-[386px]">
                <Button
                    type="submit"
                    :disabled="!token"
                    v-tooltip.top="!token ? { value: t('review_auth_tooltip'), autoHide: false } : null"
                    :pt="{ root: { class: 'send-review__btn btn-hover-default' } }"
                >
                  <p class="text-[14px]">{{ t('submit_review') }}</p>
                </Button>
              </div>

              <div v-if="hasPurchasedProduct" class="purchased-product-text">
                {{ hasPurchasedProduct }}
              </div>
            </form>
          </section>
        </section>

      </AccordionContent>
    </AccordionPanel>
  </Accordion>
</template>

<script setup>
import {capitalizeFirstLetter, formatDateToDMY} from "~/utils/index.js";
import {storeToRefs} from "pinia";
import {useAuthStore} from "~/stores/auth.js";
import {leaveReview} from "~/services/api/reviews-service.js";

const props = defineProps({
  product: {
    type: Object,
    required: true
  }
})

const tabs = {
  description: {
    header: '–û–ø–∏—Å'
  },
  delivery: {
    header: '–î–æ—Å—Ç–∞–≤–∫–∞ —Ç–∞ –æ–ø–ª–∞—Ç–∞'
  },
  reviews: {
    header: '–í—ñ–¥–≥—É–∫–∏'
  },
  characteristics: {
    header: computed(() => t('tabs_characteristics')),
    list: [
      {key: "–í–∏—Ä–æ–±–Ω–∏–∫", value: "Nutrex Research"},
      {key: "–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç—É", value: "–ê–Ω–∞–±–æ–ª—ñ—á–Ω–∞ –¥–æ–±–∞–≤–∫–∞"},
      {key: "–§–æ—Ä–º–∞ –≤–∏–ø—É—Å–∫—É", value: "–ö–∞–ø—Å—É–ª–∏"},
      {key: "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤ —É–ø–∞–∫–æ–≤—Ü—ñ", value: "60 –∫–∞–ø—Å—É–ª"},
      {key: "–û—Å–Ω–æ–≤–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏", value: "–ê–Ω–∞–±–æ–ª—ñ—á–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Å –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ—Å–ª–∏–Ω–Ω–∏—Ö —Å—Ç–µ—Ä–æ—ó–¥—ñ–≤"},
      {key: "–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è", value: "–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Å–∏–ª–∏, –≤–∏—Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —Ç–∞ –Ω–∞–±–æ—Ä—É –º‚Äô—è–∑–æ–≤–æ—ó –º–∞—Å–∏"},
      {key: "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –¥–æ–∑–∞", value: "2 –∫–∞–ø—Å—É–ª–∏ –Ω–∞ –¥–µ–Ω—å (1 –≤—Ä–∞–Ω—Ü—ñ, 1 –≤–≤–µ—á–µ—Ä—ñ)"},
      {key: "–ß–∞—Å –ø—Ä–∏–π–æ–º—É", value: "–ü—ñ—Å–ª—è —ó–∂—ñ"},
      {key: "–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ", value: "–ë–µ–∑ –≥–æ—Ä–º–æ–Ω—ñ–≤, –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ä—ñ–≤–µ–Ω—å —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω—É"},
      {key: "–ö–æ–º—É –ø—ñ–¥—Ö–æ–¥–∏—Ç—å", value: "–°–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º —Ç–∞ –±–æ–¥—ñ–±—ñ–ª–¥–µ—Ä–∞–º"},
      {key: "–ü—Ä–æ—Ç–∏–ø–æ–∫–∞–∑–∞–Ω–Ω—è", value: "–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º—ñ—Å—Ç—å, –≤–∞–≥—ñ—Ç–Ω—ñ—Å—Ç—å, –ø–µ—Ä—ñ–æ–¥ –ª–∞–∫—Ç–∞—Ü—ñ—ó"},
      {key: "–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ", value: "–í–∫–∞–∑–∞–Ω–∏–π –Ω–∞ —É–ø–∞–∫–æ–≤—Ü—ñ"},
    ]
  }
}

const MAX_REVIEW_LENGTH = 300;

const route = useRoute()
const productSlug = computed(() => route.params.slug)

const {t} = useI18n()

const token = useCookie('token')

const {currentUser} = storeToRefs(useAuthStore());

const fullNameOfUser = computed(() => token.value ? `${currentUser.value.firstName} ${currentUser.value.lastName}` : '');

const getReviewLength = computed(() => textareaValue.value.length);

const expandedComments = ref(new Set())

const isShowMoreButton = (comment) => {
  return comment.length >= 200
}

const getSlicedReview = (review) => {
  const isExpanded = expandedComments.value.has(review._id)
  if (isExpanded || review.comment.length <= 150) return review.comment;
  return review.comment.slice(0, 150) + '...'
}

const toggleComment = (reviewId) => {
  if (expandedComments.value.has(reviewId)) {
    expandedComments.value.delete(reviewId)
  } else {
    expandedComments.value.add(reviewId)
  }
}

const rating = ref(null)

const reviewerInputValue = ref(fullNameOfUser.value)

const textareaValue = ref('')

const isLoading = ref(false)

const currentPage = ref(1);
const itemsPerPage = ref(2);

const reviews = ref(props.product?.reviews?.list || [])

const isEmptyRating = ref(false)

const hasPurchasedProduct = ref('')

const paginatedReviews = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage.value;
  const end = start + itemsPerPage.value;
  return reviews.value.slice(start, end);
});

const totalPages = computed(() => {
  return Math.ceil(reviews.value.length / itemsPerPage.value);
});

const changePage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page;
  }
};

const leaveProductReview = async () => {
  if (!rating.value) {
    isEmptyRating.value = true
    return
  }

  isLoading.value = true
  isEmptyRating.value = false

  try {
    const response = await leaveReview(productSlug.value, rating.value, textareaValue.value)
    reviews.value.push(response)
    hasPurchasedProduct.value = ''
    clearFields()
  } catch (error) {
    hasPurchasedProduct.value = error.message
    console.error('Error when sending feedback:', error)
  } finally {
    isLoading.value = false
  }
}

const clearFields = () => {
  rating.value = null
  textareaValue.value = ''
}

const fullReviewerName = ({firstName, lastName}) => {
  const first = capitalizeFirstLetter(firstName ?? currentUser.value?.firstName ?? '')
  const last = capitalizeFirstLetter(lastName ?? currentUser.value?.lastName ?? '')
  return `${first} ${last}`.trim()
}

watch(() => rating.value, (newValue) => {
  if (newValue) {
    isEmptyRating.value = false
  }
})

</script>

<style scoped>
.accordion-item {
  margin-bottom: 1.5em;
  border-bottom: none;
}

.accordion-header {
  border-radius: var(--default-rounded);
}

.characteristics-list__title {
  font-size: 15px;
  line-height: 36px;
}

.characteristics-list__value {
  line-height: 36px;
  font-size: 15px;
  max-width: 40%;
  word-break: break-word;
}

.send-review__btn {
  background: var(--color-primary-dark);
  width: 100%;
}

button .arrow-path {
  stroke: #1B1F26;
  stroke-opacity: 0.72;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  transition: stroke 0.3s ease;
}

button.is-disabled .arrow-path {
  stroke: #D0D0D0;
  stroke-opacity: 1;
}

.empty-reviews-text {
  display: flex;
  width: 100%;
  justify-content: center;
  align-items: center;
}

@media (max-width: 664px) {
  .review-button__wrapper {
    margin: 0 auto;
  }

  .empty-reviews-text {
    padding: 15px;
    margin-bottom: 15px;
  }
}
@media (max-width: 450px) {
  .characteristics-list__value {
    max-width: 45%;
  }
}

</style>