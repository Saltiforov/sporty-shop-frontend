<template>
  <LoadingOverlay :visible="isLoading"/>
  <TabView :pt="{
        panelContainer: {
          class: 'bg-transparent'
        },
        navContainer: {
          class: 'border-none'
        },
         nav: {
          class: 'bg-transparent border-[0] nav-panel'
          },
          inkbar: {
           class: 'h-[4px] bg-[var(--color-primary-purple)]'
          }
      }">
    <TabPanel :header="tabs.description.header">
      <p class="m-0">
        <p class="mb-4">
          <strong>Nutrex Anabol</strong> ¬†–¥–æ–ø–æ–º–∞–≥–∞—î –∑–±—ñ–ª—å—à–∏—Ç–∏ —Å–∏–Ω—Ç–µ–∑ –ø—Ä–æ—Ç–µ—ó–Ω—É –≤ —Å–∫–µ–ª–µ—Ç–Ω–∏—Ö –º'—è–∑–∞—Ö, –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–º—É
          –∑–º–µ–Ω—à–µ–Ω–Ω—ñ –≤–ø–ª–∏–≤—É
          –ø—Ä–æ—Ç–µ–æ–ª—ñ—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤. –ù–∞–¥–∞—é—á–∏ –∫—Ä–∞—â—ñ –∞–¥–∞–ø—Ç–æ–≥–µ–Ω–Ω—ñ –µ—Ñ–µ–∫—Ç–∏ –≤ —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ —ñ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—ñ, Anabol 5
          –¥–æ–ø–æ–º–∞–≥–∞—î –¥–æ—Ä–µ–≥—É–ª—é–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π —Ü–∏–∫–ª –±—ñ–ª–∫–∞ –≤ –æ—Ä–≥–∞–Ω—ñ–∑–º—ñ.
          Anabol –≤—ñ–¥ Nutrex –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î —Å–æ–±–æ—é —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç, —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –≤ —è–∫–æ—Å—Ç—ñ –¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è
          –ø—Ä–∏ –ø—Ä–∞–≥–Ω–µ–Ω–Ω—ñ –Ω–∞–±—Ä–∞—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –≤–∞–≥—É —ñ –∑–±—ñ–ª—å—à–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä–∏, –∞ —Ç–∞–∫–æ–∂ –≤ –ø—Ä–æ—Ü–µ—Å—ñ —Å—É—à–∫–∏, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —ñ
          –Ω–∞—Ä–æ—Å—Ç–∏—Ç–∏ —è–∫—ñ—Å–Ω—ñ –º'—è–∑–∏. <strong>–©–æ —Ä–æ–±–∏—Ç—å Anabol 5 —Ç–∞–∫–∏–º –∞–Ω–∞–±–æ–ª—ñ—á–Ω–∏–º?</strong>
        </p>
        <p class="mb-4"><strong>–î—ñ-—Ü–∏–∫–ª–æ–ø–µ–Ω—Ç–∞–Ω–æ–Ω</strong> .¬†–Ñ —Å–∏–Ω—Ç–µ—Ç–∏—á–Ω–∏–º –∞–Ω–∞–ª–æ–≥–æ–º —Ä–æ—Å–ª–∏–Ω–Ω–æ–≥–æ —Å—Ç–µ—Ä–æ–ª—É –∑ –≤–∏—Å–æ–∫–æ—é
          –∞–Ω–∞–±–æ–ª—ñ—á–Ω–æ—é –¥—ñ—î—é, —è–∫–∏–π –≤–∏—è–≤–ª—è—î —Å–µ–±–µ
          –ø—Ä–∏ –∑–±—ñ–ª—å—à–µ–Ω–Ω—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ –∞–∑–æ—Ç—É –≤ –º'—è–∑–∞—Ö. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤ Anabol 5 –¥—ñ-—Ü–∏–∫–ª–æ–ø–µ–Ω—Ç–∞–Ω–æ–Ω —Å–ø—Ä–∏—è—î –∑–±—ñ–ª—å—à–µ–Ω–Ω—é
          –≤–º—ñ—Å—Ç—É
          –±—ñ–ª–∫–∞ –≤ –º'—è–∑–∞—Ö, –∞ —Ü–µ –≤ —Å–≤–æ—é —á–µ—Ä–≥—É —Å–ø—Ä–∏—á–∏–Ω—è—î –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –º'—è–∑–æ–≤–æ—ó –º–∞—Å–∏.</p>
        <p class="mb-4"><strong>6-–∫–µ—Ç–æ-–¥–∏–æ—Å–≥–µ–Ω–∏–Ω –∞—Ü–µ—Ç–∞—Ç, –ø—Ä–æ–ø—ñ–æ–Ω–∞—Ç, —Ü–∏–ø—ñ–æ–Ω–∞—Ç, –¥–µ–∫–∞–Ω–æ–∞—Ç-–µ—Ñ—ñ—Ä</strong>
          6-–∫–µ—Ç–æ-–¥–∏–æ—Å–≥–µ–Ω–∏–Ω –∞—Ü–µ—Ç–∞—Ç, –ø—Ä–æ–ø—ñ–æ–Ω–∞—Ç, —Ü–∏–ø—ñ–æ–Ω–∞—Ç, –¥–µ–∫–∞–Ω–æ–∞—Ç-–µ—Ñ—ñ—Ä.¬†6-–∫–µ—Ç–æ-–¥—ñ–æ—Å–≥–µ–Ω—ñ–Ω —î —Å–∞–ø–æ–Ω—ñ–Ω–æ–º –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ
          –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è, —è–∫–∏–π –≤–∏—è–≤–ª—è—î –∞–Ω–∞–±–æ–ª—ñ—á–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, –Ω–µ –ø—Ä–æ—è–≤–ª—è—é—á–∏ –∂–æ–¥–Ω–∏—Ö –∞–Ω–¥—Ä–æ–≥–µ–Ω–Ω–∏—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π. –ô–æ–≥–æ
          –∞–Ω–∞–±–æ–ª—ñ–∑–º –ø–æ–ª—è–≥–∞—î –≤ –∑–±—ñ–ª—å—à–µ–Ω–Ω—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ –∞–∑–æ—Ç—É. –ö—Ä—ñ–º —Ü—å–æ–≥–æ, 6-–∫–µ—Ç–æ-–¥—ñ–æ—Å–≥–µ–Ω—ñ–Ω –≤ –Ω–∞—É–∫–æ–≤–∏—Ö –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è—Ö
          –ø–æ–∫–∞–∑–∞–≤
          —Å–≤–æ—é –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ –Ω–∞–±–æ—Ä—ñ –º'—è–∑–æ–≤–æ—ó –º–∞—Å–∏. 6-–∫–µ—Ç–æ-–¥—ñ–æ—Å–≥–µ–Ω—ñ–Ω –≤ Anabol 5 –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ 4 —Ä—ñ–∑–Ω–∏–º–∏ –µ—Ñ—ñ—Ä–∞–º–∏, —â–æ
          –≥–∞—Ä–∞–Ω—Ç—É—é—Ç—å —à–≤–∏–¥–∫—É, —Å–µ—Ä–µ–¥–Ω—é —ñ —Ç—Ä–∏–≤–∞–ª—É –¥—ñ—é.
          –ì–µ–∫–æ–≥–µ–Ω—ñ–Ω –∞—Ü–µ—Ç–∞—Ç.¬†–ì–µ–∫–æ–≥–µ–Ω—ñ–Ω ‚Äì —Ü–µ —Ç–∞–∫–æ–∂ –µ—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è —Å–∞–ø–æ–Ω—ñ–Ω–∞ –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ
          –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤—ñ–Ω –ø–æ–∫–∞–∑–∞–≤ —Å–≤–æ—é –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ –∑–Ω–∏–∂–µ–Ω–Ω—ñ –º'—è–∑–æ–≤–æ–≥–æ –∑–∞–ø–∞–ª–µ–Ω–Ω—è. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤—ñ–Ω –¥–æ–ø–æ–º–∞–≥–∞—î
          –ø–æ–ª—ñ–ø—à–∏—Ç–∏ –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞–ª—å–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏ –ø—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è —ñ —Å–ø—Ä–∏—è—î –∑–±—ñ–ª—å—à–µ–Ω–Ω—é –º'—è–∑–æ–≤–æ—ó –º–∞—Å–∏ —ñ —Å–∏–ª–∏.</p>
        <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:</strong> –ü—Ä–∏–π–º–∞–π—Ç–µ 1 —Ä—ñ–¥–∫—É –∫–∞–ø—Å—É–ª—É –≤—Ä–∞–Ω—Ü—ñ —Ç–∞ 1 —Ä—ñ–¥–∫—É –∫–∞–ø—Å—É–ª—É
          –≤–≤–µ—á–µ—Ä—ñ. –î–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
          –Ω–∞–π–∫—Ä–∞—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —â–æ–¥–Ω—è —ñ —Ü–∏–∫–ª—ñ—á–Ω–æ. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ü–∏–∫–ª—É ‚Äì 12 —Ç–∏–∂–Ω—ñ–≤, 4 —Ç–∏–∂–Ω—ñ
          –ø–µ—Ä–µ—Ä–≤–∞.</p>
      </p>
    </TabPanel>
    <TabPanel :header="tabs.characteristics.header">
      <div class="characteristics-list max-w-[1030px] w-full">
        <div
            v-for="characteristic in tabs.characteristics.list"
            :key="characteristic.key"
            class="flex items-center gap-4 py-2"
        >
          <p class="characteristics-list__title whitespace-nowrap">
            {{ characteristic.key }}
          </p>
          <div
              class="flex-grow h-px bg-[#5856D6]"
              style="margin-top: 1em;"
          ></div>
          <p class="characteristics-list__value whitespace-nowrap">
            {{ characteristic.value }}
          </p>
        </div>
      </div>
    </TabPanel>
    <TabPanel :header="tabs.delivery.header">
      <div class="delivery-and-payment">
        <div class="mb-4">
          <strong class="fw-600 leading-[33px]">–û–ø–ª–∞—Ç–∞</strong>
        </div>
        <p class="mb-4">–û–ø–ª–∞—Ç–∞ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ <strong>Telegram</strong>. –ü—ñ—Å–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—à
          –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤‚Äô—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É Telegram –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –Ω–∞–¥–∞—Å—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –æ–ø–ª–∞—Ç–∏.</p>
        <div class="mb-4">
          <strong>–î–æ—Å—Ç—É–ø–Ω—ñ –º–µ—Ç–æ–¥–∏ –æ–ø–ª–∞—Ç–∏:</strong>
          <ul class="list-disc pl-6">
            <li>–ë–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π –ø–µ—Ä–µ–∫–∞–∑ (Monobank, –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫ —Ç–∞ —ñ–Ω—à—ñ)</li>
            <li>–ü–µ—Ä–µ–∫–∞–∑ –Ω–∞ –∫–∞—Ä—Ç–∫—É</li>
            <li>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (–∑–∞ –∑–∞–ø–∏—Ç–æ–º)</li>
          </ul>
        </div>

        <div class="mb-4">
          <strong>–î–æ—Å—Ç–∞–≤–∫–∞</strong>
          <div>
            <p>–ü–æ –£–∫—Ä–∞—ó–Ω—ñ:</p>
            <ul class="list-disc pl-6">
              <li>–ù–æ–≤–∞ –ü–æ—à—Ç–∞ ‚Äì 1-3 –¥–Ω—ñ, –∑–≥—ñ–¥–Ω–æ –∑ —Ç–∞—Ä–∏—Ñ–∞–º–∏ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</li>
              <li>–£–∫—Ä–ø–æ—à—Ç–∞ ‚Äì 3-7 –¥–Ω—ñ–≤</li>
            </ul>
          </div>
          <div>
            <p>–ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞:</p>
            <ul class="list-disc pl-6">
              <li>–î–æ—Å—Ç–∞–≤–∫–∞ –≤ —ñ–Ω—à—ñ –∫—Ä–∞—ó–Ω–∏ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ –ø–æ—à—Ç–æ–≤—ñ —Å–µ—Ä–≤—ñ—Å–∏</li>
              <li>–¢–µ—Ä–º—ñ–Ω–∏ —Ç–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∫—Ä–∞—ó–Ω–∏ –æ–¥–µ—Ä–∂—É–≤–∞—á–∞ —Ç–∞ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</li>
              <li>–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∫–∏</li>
            </ul>
          </div>

        </div>

        <div>
          <div>
            <p>üìå –í–∞–∂–ª–∏–≤–æ!</p>
            <ul class="list-disc pl-6">
              <li>–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ—ó –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∏</li>
              <li>–¢–æ—á–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–æ—ó –¥–æ—Å—Ç–∞–≤–∫–∏ —É—Ç–æ—á–Ω—é–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ Telegram</li>
            </ul>
          </div>
        </div>
      </div>
    </TabPanel>
    <TabPanel :header="tabs.reviews.header">
      <div class="reviews-content murecho-font flex justify-between">
        <div v-if="paginatedReviews.length" class="review-list pt-[26px] justify-self-start">

          <div
              class="review-card mb-[23px] last:mb-0 max-w-[518px]"
              v-for="review in paginatedReviews"
              :key="review.id"
          >
            <div class="flex mb-2 items-center">
              <strong class="mr-4"><p class="review-card__name fw-600">{{ fullReviewerName(review.user) }}</p></strong>
              <div class="review-card__date mr-2 text-[14px]">{{ formatDateToDMY(review.createdAt) }}</div>
              <div class="review-card__stars mr-3">
                <Rating v-model="review.rating" readonly>
                  <template #onicon>
                    <img src="@/assets/icons/star-filled.svg" class="mr-1"/>
                  </template>
                  <template #officon>
                    <img src="@/assets/icons/star-empty.svg" class="mr-1"/>
                  </template>
                </Rating>
              </div>
              <div class="review-card__confirmed text-[#ADADAD] fw-400">
                <p v-if="review.purchaseConfirmed">{{ t('purchase_confirmed') }}</p>
                <p v-else>{{ t('purchase_not_confirmed') }}</p>
              </div>
            </div>

            <p class="review-card__comment">{{ getSlicedReview(review) }}</p>
            <p
                v-if="isShowMoreButton(review.comment)"
                class="flex cursor-pointer justify-end text-[12px] text-[var(--color-muted-light-gray)] fw-500"
                @click="toggleComment(review._id)"
            >
              {{ expandedComments.has(review._id) ? 'Hide' : 'Read more' }}
            </p>
          </div>
          <div class="pagination-wrapper flex justify-end">
            <div class="pagination flex justify-between items-center  max-w-[80px] w-full">
              <button
                  @click="changePage(currentPage - 1)"
                  :disabled="currentPage === 1"
                  :class="{ 'is-disabled': currentPage === 1 }"
              >
                <svg
                    width="21"
                    height="21"
                    viewBox="0 0 21 21"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                      class="arrow-path"
                      d="M11.5 13.5L8.5 10.5L11.5 7.5M19.5 10.5C19.5 5.52944 15.4706 1.5 10.5 1.5C5.52944 1.5 1.5 5.52944 1.5 10.5C1.5 15.4706 5.52944 19.5 10.5 19.5C15.4706 19.5 19.5 15.4706 19.5 10.5Z"
                  />
                </svg>
              </button>
              <span>{{ currentPage }}</span>
              <button
                  @click="changePage(currentPage + 1)"
                  :disabled="currentPage * itemsPerPage >= reviews.length"
                  :class="{ 'is-disabled': currentPage * itemsPerPage >= reviews.length }"
              >
                <svg
                    width="21"
                    height="21"
                    viewBox="0 0 21 21"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                      class="arrow-path"
                      d="M9.5 7.5L12.5 10.5L9.5 13.5M19.5 10.5C19.5 5.52944 15.4706 1.5 10.5 1.5C5.52944 1.5 1.5 5.52944 1.5 10.5C1.5 15.4706 5.52944 19.5 10.5 19.5C15.4706 19.5 19.5 15.4706 19.5 10.5Z"
                  />
                </svg>
              </button>
            </div>
          </div>

        </div>

        <div v-else class="flex w-full items-center justify-center">
          <p class="text-[var(--color-primary-black)] text-[26px] italic">{{ t('no_reviews_yet') }}</p>
        </div>

        <div class="review-form max-w-[642px] w-full">
          <div class="mb-4">
            <h2 class="form-title fw-500">{{ t('new_review') }}</h2>
          </div>
          <div class="mb-4 rounded-[8px] max-w-[354px]">
            <InputText :disabled="!token" v-model="reviewerInputValue" class="w-full h-[42px] py-[10px] rounded-[8px]"
                       :placeholder="t('your_name')"/>
          </div>
          <div class="rounded-[8px]">
          <Textarea :disabled="!token" :maxlength="MAX_REVIEW_LENGTH" v-model="textareaValue" style="resize: none"
                    class="w-full rounded-[8px]"
                    :placeholder="t('share_your_impressions')" rows="5" cols="30"/>
          </div>
          <div class="mb-[10px] text-[var(--color-muted-light-gray)] flex justify-end">
            {{ getReviewLength }} / {{ MAX_REVIEW_LENGTH }}
          </div>
          <div class="rate-product mb-[27px] flex items-center">
            <p class="mr-[10px] text-[14px]">{{ t('rate_product') }}</p>
            <Rating :disabled="!token" v-model="rating">
              <template #onicon>
                <img src="@/assets/icons/star-filled.svg" class="mr-1"/>
              </template>
              <template #officon>
                <img src="@/assets/icons/star-empty.svg" class="mr-1"/>
              </template>
            </Rating>
          </div>

          <div class="rounded-[8px] max-w-[386px]">
            <Button :disabled="!token"
                    v-tooltip.top="!token ? { value: t('review_auth_tooltip'), autoHide: false } : null"
                    @click="leaveProductReview" :pt="{
            root: {
              class: 'send-review__btn btn-hover-default'
            }
          }">
              <p class="text-[14px]">{{ t('submit_review') }}</p>
            </Button>
          </div>
        </div>
      </div>
    </TabPanel>
  </TabView>
</template>

<script setup>

import {leaveReview, getReviewByProduct} from "~/services/api/reviews-service.js";
import {formatDateToDMY} from "~/utils/index.js";
import LoadingOverlay from "~/components/UI/LoadingOverlay/LoadingOverlay.vue";
import {storeToRefs} from "pinia";
import {useAuthStore} from "~/stores/auth.js";

const MAX_REVIEW_LENGTH = 300;

const route = useRoute()
const productId = computed(() => route.params.id)

const {t} = useI18n()

const token = useCookie('token')

const {currentUser} = storeToRefs(useAuthStore());

const fullNameOfUser = computed(() => token.value ? `${currentUser.value.firstName} ${currentUser.value.lastName}` : '');

const getReviewLength = computed(() => textareaValue.value.length);

const expandedComments = ref(new Set())

const isShowMoreButton = (comment) => {
  return comment.length >= 200
}

const getSlicedReview = (review) => {
  const isExpanded = expandedComments.value.has(review._id)
  if (isExpanded || review.comment.length <= 150) return review.comment;
  return review.comment.slice(0, 150) + '...'
}

const toggleComment = (reviewId) => {
  if (expandedComments.value.has(reviewId)) {
    expandedComments.value.delete(reviewId)
  } else {
    expandedComments.value.add(reviewId)
  }
}

const rating = ref(null)

const reviewerInputValue = ref(fullNameOfUser.value)

const textareaValue = ref('')

const isLoading = ref(false)

const currentPage = ref(1);
const itemsPerPage = ref(2);
const reviews = ref([])

const paginatedReviews = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage.value;
  const end = start + itemsPerPage.value;
  return reviews.value.slice(start, end);
});

const totalPages = computed(() => {
  return Math.ceil(reviews.value.length / itemsPerPage.value);
});

const changePage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page;
  }
};

const leaveProductReview = async () => {
  isLoading.value = true
  await leaveReview(productId.value, rating.value, textareaValue.value)
  clearFields()
  isLoading.value = false
}

const clearFields = () => {
  rating.value = null
  textareaValue.value = ''
}

const fullReviewerName = ({firstName, lastName}) => {
  return `${firstName} ${lastName}`
}

onMounted(async () => {
  reviews.value = await getReviewByProduct(productId.value)
})

const tabs = {
  description: {
    header: computed(() => t('tabs_description')),
  },
  delivery: {
    header: computed(() => t('tabs_delivery'))
  },
  reviews: {
    header: computed(() => t('tabs_reviews')),
  },
  characteristics: {
    header: computed(() => t('tabs_characteristics')),
    list: [
      {key: "–í–∏—Ä–æ–±–Ω–∏–∫", value: "Nutrex Research"},
      {key: "–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç—É", value: "–ê–Ω–∞–±–æ–ª—ñ—á–Ω–∞ –¥–æ–±–∞–≤–∫–∞"},
      {key: "–§–æ—Ä–º–∞ –≤–∏–ø—É—Å–∫—É", value: "–ö–∞–ø—Å—É–ª–∏"},
      {key: "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤ —É–ø–∞–∫–æ–≤—Ü—ñ", value: "60 –∫–∞–ø—Å—É–ª"},
      {key: "–û—Å–Ω–æ–≤–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏", value: "–ê–Ω–∞–±–æ–ª—ñ—á–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Å –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ—Å–ª–∏–Ω–Ω–∏—Ö —Å—Ç–µ—Ä–æ—ó–¥—ñ–≤"},
      {key: "–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è", value: "–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Å–∏–ª–∏, –≤–∏—Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —Ç–∞ –Ω–∞–±–æ—Ä—É –º‚Äô—è–∑–æ–≤–æ—ó –º–∞—Å–∏"},
      {key: "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –¥–æ–∑–∞", value: "2 –∫–∞–ø—Å—É–ª–∏ –Ω–∞ –¥–µ–Ω—å (1 –≤—Ä–∞–Ω—Ü—ñ, 1 –≤–≤–µ—á–µ—Ä—ñ)"},
      {key: "–ß–∞—Å –ø—Ä–∏–π–æ–º—É", value: "–ü—ñ—Å–ª—è —ó–∂—ñ"},
      {key: "–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ", value: "–ë–µ–∑ –≥–æ—Ä–º–æ–Ω—ñ–≤, –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ä—ñ–≤–µ–Ω—å —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω—É"},
      {key: "–ö–æ–º—É –ø—ñ–¥—Ö–æ–¥–∏—Ç—å", value: "–°–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º —Ç–∞ –±–æ–¥—ñ–±—ñ–ª–¥–µ—Ä–∞–º"},
      {key: "–ü—Ä–æ—Ç–∏–ø–æ–∫–∞–∑–∞–Ω–Ω—è", value: "–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º—ñ—Å—Ç—å, –≤–∞–≥—ñ—Ç–Ω—ñ—Å—Ç—å, –ø–µ—Ä—ñ–æ–¥ –ª–∞–∫—Ç–∞—Ü—ñ—ó"},
      {key: "–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ", value: "–í–∫–∞–∑–∞–Ω–∏–π –Ω–∞ —É–ø–∞–∫–æ–≤—Ü—ñ"},
    ]
  }
}
</script>

<style scoped>
.send-review__btn {
  background: var(--color-primary-dark);
  width: 100%;
}

button .arrow-path {
  stroke: #1B1F26;
  stroke-opacity: 0.72;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  transition: stroke 0.3s ease;
}

button.is-disabled .arrow-path {
  stroke: #D0D0D0;
  stroke-opacity: 1;
}
</style>