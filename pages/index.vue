<template>
  <div>
    <LoadingOverlay :visible="isLoading"/>

    <div class="max-w-[1756px] mx-auto ">
      <div class="sort-select flex w-full justify-end">
        <div class="min-w-[320px] p-1 flex">
          <p class="mr-5 sort-title">{{ sortTitle }}</p>
          <SortSelect/>
        </div>
      </div>

      <div class="main-content-container grid-cols-1 grid lg:grid-cols-[390px_1fr] gap-[30px]">
        <aside class="p-4 rounded-md">
          <div class="filters mb-[91px] w-full max-w-[354px] h-[554px] border rounded-[var(--default-rounded)]">
            <Filters v-if="hydrated"/>
            <FiltersSkeleton v-else/>
          </div>

          <div class="promotional-products text-center">
            <p class="text-[var(--color-primary-pink)] mb-[21px] fw-600 text-[20px]">{{ t('promo_products_title') }}</p>
            <SwiperWrapper
                v-if="hydrated"
                :items="promotionalProducts"
                :options="promotionalProductsSwiperOptions"
            >
              <template #default="{ item }">
                <ProductCard
                    class="mt-3 mb-3"
                    :product="item"
                    @add-to-cart="showProductAddedToast"
                    @click="addProductToViewed(item)"
                />
              </template>
            </SwiperWrapper>

            <div v-else class="flex gap-4 overflow-x-auto">
              <ProductSkeleton
                  class="min-w-[180px]"
              />
            </div>
          </div>
        </aside>

        <div>
          <div
              class="product-grid">

            <template v-if="!hydrated">
              <ProductSkeleton v-for="i in 10" :key="'loading-skeleton-' + i"/>
            </template>

            <template v-else>
              <ProductCard
                  v-for="product in products"
                  :key="product.id"
                  :product="product"
                  @add-to-cart="showProductAddedToast"
                  @click="addProductToViewed(product)"

              />
            </template>
          </div>

          <div class="products-pagination-actions mb-[72px]">
            <div class="load-more-wrapper mb-3 flex justify-center">
              <LoadMoreButton
                  v-if="!isLoading"
                  :disabled="allLoaded"
                  :label="loadMoreLabel"
                  @click="fetchProducts(false)"
              >
                <template #icon>
                  <img src="~/assets/icons/load-more-icon.svg" alt="load-more-icon">
                </template>
              </LoadMoreButton>
              <LoadMoreButtonSkeleton v-else/>
            </div>
            <div class="product-pagination-wrapper flex justify-center">
              <ProductPaginationButton
                  v-if="!isLoading"
                  v-model="activePage"
                  :max-pages="totalPages"
                  :all-loaded="allLoaded"
                  @update:model-value="getProductsByPage"
              />
              <PaginationButtonSkeleton v-else/>
            </div>
          </div>
        </div>
      </div>


    </div>

  </div>
</template>


<script setup>
import ProductSkeleton from '~/components/Skeletons/ProductSkeleton/ProductSkeleton.vue'

definePageMeta({
  layout: 'default',
})

import ProductCard from "~/components/Cards/ProductCard/ProductCard.vue";
import SortSelect from "~/components/UI/SortSelect/SortSelect.vue";
import LoadMoreButton from "~/components/UI/LoadMoreButton/LoadMoreButton.vue";
import ProductPaginationButton from "~/components/UI/ProductPaginationButton/ProductPaginationButton.vue";
import Filters from "~/components/UI/Filters/Filters.vue";
import LoadingOverlay from "~/components/UI/LoadingOverlay/LoadingOverlay.vue";
import {useQueryParams} from "~/composables/useQueryParams.js";
import {getAllProducts, getProductsOnSale} from "~/services/api/product-service.js";

import {useToastManager} from "~/composables/useToastManager.js";
import {useViewedProducts} from "~/composables/useViewedProducts.js";
import FiltersSkeleton from "~/components/Skeletons/FiltersSkeleton/FiltersSkeleton.vue";
import PaginationButtonSkeleton from "~/components/Skeletons/PaginationButtonSkeleton/PaginationButtonSkeleton.vue";
import LoadMoreButtonSkeleton from "~/components/Skeletons/LoadMoreButtonSkeleton/LoadMoreButtonSkeleton.vue";
import {getStaticPagesInfo} from "~/services/api/static-info.js";
import {useStaticPages} from "~/stores/staticPages.js";
import { useCurrencyStore } from "~/stores/currency.js";

const promotionalProductsSwiperOptions = {
  slidesPerView: 1,
  loop: true,
}

const {addProductToViewed} = useViewedProducts()

const {$eventBus} = useNuxtApp()

const staticPagesStore = useStaticPages()

const currencyStore = useCurrencyStore()

const hydrated = ref(false)

const {t} = useI18n();

const {showProductAddedToast} = useToastManager()

const route = useRoute()

const sortTitle = computed(() => t('sort_title'))

const activePage = ref(Number(route.query.page))

const page = ref(Number(route.query.page) || 1)

const limit = ref(Number(route.query.limit) || 10)

const skip = computed(() => (page.value - 1) * limit.value)

const totalProductsRecords = ref(0)

const promotionalProducts = ref([])

const totalPages = computed(() => Math.ceil(totalProductsRecords.value / limit.value))

const allLoaded = computed(() => products.value.length >= totalProductsRecords.value || activePage.value === totalPages.value)

const loadMoreLabel = computed(() => {
  return t('load_more', {count: limit.value});
});

const productsQueryParams = computed(() => {
  const query = {
    page: page.value,
    limit: limit.value,
    skip: skip.value,
  }
  return query
})

const getPromotionalProducts = async () => {
  const response = await getProductsOnSale()
  promotionalProducts.value = response.list
}

const getProductsByPage = async (newPage) => {
  page.value = newPage
  await fetchProducts(true)
}

const syncFromRoute = () => {
  const pageFromQuery = Number(route.query.page) || 1
  if (page.value !== pageFromQuery) {
    page.value = pageFromQuery
  }

  productsQueryParams.value = {...productsQueryParams.value, page: page.value}
  updateQueryParams()
}

const {updateQueryParams} = useQueryParams(productsQueryParams);

const products = ref([])

const paginationProducts = ref([])

const foundProducts = ref([])

const isLoading = ref(true)

const fetchProducts = async (shouldReplace = false, params = {}) => {
  try {
    isLoading.value = true

    if (!shouldReplace) {
      page.value += 1
    }

    const queryWithoutPage = Object.fromEntries(
        Object.entries(productsQueryParams.value).filter(([key]) => key !== 'page')
    )

    const response = await getAllProducts({...queryWithoutPage, ...params})

    if (totalProductsRecords.value === 0) {
      totalProductsRecords.value = response.count
    }

    if (shouldReplace) {
      products.value = [...response.list]
      updateQueryParams()
    } else {
      products.value.push(...response.list)
    }


  } finally {
    isLoading.value = false
  }
}

watch(
    () => route.query.q,
    async (newSearch, oldSearch) => {
      if (!newSearch || newSearch.trim() === '') {
        foundProducts.value = []

        $eventBus.emit('products-found', [])
        return
      }

      if (newSearch !== oldSearch) {
        page.value = 1
        products.value = []
        totalProductsRecords.value = 0

        const query = {}

        if (route.query.q && route.query.q.trim() !== '') {
          query.q = route.query.q
        }

        await fetchProducts(true, query)

        foundProducts.value = [...products.value]
        $eventBus.emit('products-found', foundProducts.value)
      }
    },
    {immediate: true}
)

const searchStore = useSearchStore()

onMounted(async () => {
  syncFromRoute()

  searchStore.setSearchCallback(async (query) => {
    console.log('🔍 Поиск снаружи:', query)
  })

  await getPromotionalProducts()

  await fetchProducts(true)

  hydrated.value = true
});

onBeforeUnmount(() => {
})
</script>

<style scoped>
.product-grid {
  display: grid;
  gap: 30px;
  padding: 16px;
  margin-bottom: 45px;
  max-width: 100%;
  width: 100%;
  grid-template-columns: repeat(4, 1fr);
}


@media (max-width: 1670px) {
  .product-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 1610px) {
  .product-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 1355px) {
  .product-grid {
    padding: 16px 0px;
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 1024px) {
  .promotional-products {
    display: none;
  }

  .product-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  aside {
    display: none;
  }
}

@media (max-width: 800px) {
  .product-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}


@media (max-width: 750px) {
  .sort-select {
    margin-top: 30px;
  }
  .sort-title {
    font-size: 15px;
  }
}

@media (max-width: 700px) {
  .product-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 500px) {
  .product-grid {
    gap: 5px;
  }
}




</style>